apiVersion: skaffold/v4beta5
kind: Config
metadata:
  name: workshop-service-management
build:
  artifacts:
    - image: docker.host.internal:5000/address-validation
      context: address-validation-service
      docker:
        dockerfile: Dockerfile
    - image: docker.host.internal:5000/billing
      context: billing-service
      docker:
        dockerfile: Dockerfile
    - image: docker.host.internal:5000/billing-v2
      context: billing-service-v2
      docker:
        dockerfile: Dockerfile
    - image: docker.host.internal:5000/customer
      context: customer-service
      docker:
        dockerfile: Dockerfile
    - image: docker.host.internal:5000/delivery
      context: delivery-service
      docker:
        dockerfile: Dockerfile

deploy:
  helm:
    releases:
      - name: ingress-nginx
        repo: https://kubernetes.github.io/ingress-nginx
        remoteChart: ingress-nginx
        namespace: ingress-nginx
        createNamespace: true
        valuesFiles:
          - ./ingress-nginx-values.yaml
      - name: linkerd-crds
        repo: https://helm.linkerd.io/stable
        remoteChart: linkerd-crds
        namespace: linkerd
        createNamespace: true
      - name: linkerd-control-plane
        repo: https://helm.linkerd.io/stable
        remoteChart: linkerd-control-plane
        namespace: linkerd
        createNamespace: true
        setFiles:
          identityTrustAnchorsPEM: ./ca.crt
          "identity.issuer.tls.crtPEM": ./issuer.crt
          "identity.issuer.tls.keyPEM": ./issuer.key
  statusCheckDeadlineSeconds: 300
  tolerateFailuresUntilDeadline: true

  kubectl: {}

manifests:
  kustomize:
    paths:
      - deployment/base
